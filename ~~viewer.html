<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>30-Second Viewer</title>
	<meta name="description" content="An time interval image viewer, for timed gesture drawing practice." />
	<meta name="author" content="Pharan">

	<style type="text/css">
		body {					/* with totally badass image embedding */
			font-family: "Open Sans", "Inter UI", "San Francisco", "Segue UI", "Helvetica", "Arial", sans-serif;
			background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyBAMAAADsEZWCAAAALVBMVEXi4uLj4+Pk5OTl5eXm5ubn5+fo6Ojp6enq6urr6+vs7Ozt7e3u7u7v7+/w8PDpFgWzAAAEBElEQVR4Xg3Rz3LTRhgA8D32RUKGaykOuROwOXUg0kYh7XRK5bUCPTTx7refnBNEWq3CiXq1+ynuhSn+A0xPDU6gVwgGXqO3PkR5g9/Mj7mtMAOUp2c3Dq+G9N21MR0kqtwvOQN46rIgsCG4EZSP7fV0f+nwd2AcZVRvd6nqX/wGs93PXu64E++jmiXN7vGRAxPZ2CHQl3TZKW8fQs8zGmbt7uXAzXYFEWnTMT738WLHMv6ATM9wqUuw/K/jK9XMznqUOWJOEgyaputPoqAUgMGiNU4PGzYqyXPZDT4pQOo7cge225cIB5xdmd4/hO01t/nni6shL0zcohGDaw1ntwrDoTDrGvQq5Z8/wMBUEsWjFyw8dBZOfNcnvkIZNMm8KvS+uGQRHJUdBN96qE7GWzx+Wi0eqOEhspsmcKUwd81TMZ33FsBN4vA7CazBoa0scEAvaHV16ZuFkIK6hvlvHNBoHiHJd6NpBaHRz28DBcUMZmZJUnq9U+rHGZi+1uZTn4glxzjjZSRRxutnu6PUw/HkLoxUyyrLp4kIVZMYvkjsBZDsXQg3KJkneonwJk9bb0jogq8S6zM3NOzexYt4P82/bLzvVA7rbhPb1b3LGixT8pfBqJxQXW04g8MENNo/Hu9YyYxJiz1X9jHgmd8bYxPWfSoEBjbO6nQeUerrMEbeBnPjkD//1VeK1f4hScztT8Xomb25riE7G5wqPPzEJqqK5QISOwX/9R8FIlDFJTC58dWOHyE8lLVptSlq8Dlxv8GO094b7vvBAweAyFFK1Hl/QoZtEYhlJiexBJy5D26iIcKDV+BYpISw6X9r5pbLZcxX7SSN3VrTZAwaXhVm7wEJrQC5T7wnFzzmDBc+hJZ/1P5o2fYJvBB0aTPos5osB/AVfz3qqwBlkSlb7EQomSoduZEIRXQkpa5QRH6geLpvGR7qlVJJ7odJ69qRQlPXoKBBtlKPTCGxl56Gyhv545yav3vGNLvsYjHedCNl4gm5DcO1T6Li/iw6Fay8XSZJdawyudD9WSaJlIizxS3ODmI37KGDtshK3Grw+4Sc3qu4YFbN74lgjrxtUMfwL38EAYhrz1q0S5htFhJM4otBTdKMSklrnlW5z1/KbbX/1g6N0jjsv1KhlvwTExdS4RBOBf+5oaNcuiUIs9yaeAbjQBG353I2/OG8H+Zmpnmgb/8pGYlyoTbPefhgNoG8WMxUYueNj9jGET3bVbDekENZbRO/fKIjByZjSV7Orlde+lEUoCOCRQNStHPOLD9+6yGbVttXrABEaWKz129Tz9I7BZ6DjitAPGjFcogxUh/uEuMrnphBXEOR5gcIr4iKSYPdaZ9pKVwHNNJSVIVpTsB7imT0uvgf5PFlKRRtYrEAAAAASUVORK5CYII=);
		}
		
		/* transitions */
		#welcome, #welcome.helpon, #welcome.helpoff,
		#leftarrow,
		#rightarrow,
		#arrowholder,
		header
		{
			-moz-transition:		all .3s cubic-bezier(.5, .01, .1, 1.00);
			-webkit-transition:		all .3s cubic-bezier(.5, .01, .1, 1.00);
			-o-transition:			all .3s cubic-bezier(.5, .01, .1, 1.00);
			transition:				all .3s cubic-bezier(.5, .01, .1, 1.00);
		}

		/* shadows */
		#leftarrow,
		#rightarrow
		{
			text-shadow: 	0px -1px 0px #bbb;
		}

		/* unselectables */
		#leftarrow,
		#rightarrow,
		#imageholder,
		#timeleft
		{
			user-select:	 		none;
			-moz-user-select:		none;
			-webkit-user-select:	none;
		}
		
		/*	*	*	HEADER	*	*	*/
		#usersecondsbox, header h1 {
			font-family: 	"Open Sans Light", "Segoe UI Light", "Museo Sans 500", "Gotham Book", "Open Sans", "Trebuchet", "Helvetica", "Arial", sans-serif;
			font-size:		30px;
			font-weight: 	normal;
			color:			#777;
		}
		#usersecondsbox {
			text-align:				right;
			border:					1px solid transparent;
			background-color:		transparent;
		}
		#usersecondsbox::selection {			background-color:		#bcc;		}
		#usersecondsbox::-moz-selection {		background-color:		#bcc;		}
		#usersecondsbox:hover {
			border:					1px solid #ccc;
		}
		#usersecondsbox:focus {
			border:					1px solid #ccc;
			background-color:		#fafafa;
		}
		header h1 {
			display:			inline;
			line-height: 		1em;
			margin: 			0px;
			margin-left:		-2px;
			padding:			0px;
		}
		header {
			position:			fixed;
			bottom: 			-15px;
			left: 				20px;
			background-color: 	rgba(255,255,255,0.3);
			border: 			#ccc solid 1px;
			padding:			20px 20px;
			opacity:			.8;
		}
		header:hover {
			background-color: 	rgba(255,255,255,0.5);
			padding:			30px 20px;
			opacity: 			1.0;
			bottom: 			-8px;
		}
		#tgh {
			font-size:			10px;
			color:				#aaa;
			margin:				0px 1em;
		}
		#fileinput {
			color:				#ccc;
		}
		#overallholder {
			position: 			fixed;
			top: 				50px;
			width: 				100%;
			margin: 			0px;
			padding: 			0px;
		}
		
		/*	*	*	ARROWS	*	*	*/
		#arrowholder {
			width: 				350px;
			margin-left: 		-175px;
			position: 			fixed;
			left: 				50%;
			top: 				-1px;
		}
		
		#leftarrow,
		#rightarrow
		{
			/*position and size*/
			position: 			absolute;
			top: 				-10px;
			font-size: 			50px;
			width: 				80px;
			height: 			60px;
			text-align: 		center;
			
			/*styling*/
			cursor: 			pointer;
			color: 				#f6f6f6;
		}
		#leftarrow:hover,
		#rightarrow:hover
		{
			background-color: rgba(255,255,255,0.2);
		}
		#leftarrow	{	left: 10px;		}
		#rightarrow	{	right: 10px;		}

		#timeleft {
			position: 			absolute;
			font-size: 			20px;
			top: 				15px;
			color: 				#bbb;
			left: 				50%;
			margin-left: 		-80px;
			width: 				150px;
			height: 			50px;
			line-height:		0.3em;
		}

		/*	*	*	IMAGE HOLDER	*	*	*/
		#imageholder {
			position: 			relative;
			min-width: 			50px;
			min-height: 		50px;
			margin:				0px auto;
			text-align: 		center;
		}
		#imagecaption {
			color:				#ccc;
			font-size:			14px;
		}
		#imagecaption:hover {
			color: 				#bbb;
		}
		#image {
			position:			relative;
			max-height:			800px;
			margin:				0px auto;
			padding: 			0px;
		}
		#image.fullsize {
			max-height:			none;
		}
		
		
		/*	*	*	WELCOME MESSAGE		*	*	*/
		#welcome, #welcome.helpon {
			font-size: 		12px;
			color: 			#777;
			padding:		1.5em;
			overflow:		hidden;
			text-align:		justify;
		}
		#welcome.helpoff {
			height: 		0px;
			width: 			200px;
			padding: 		0px;
		}
		#welcome.helpon	{
			height:			auto;
			width: 			400px;
			margin-top:		8px;
			padding-top:	3px;
			
			border-top:		1px dotted #bbb;
		}
		#welcome.helpon p {
			margin-top: 5px;
		}
		#welcome.helpoff p {
			margin-top: -5px;
		}
		ol {
			padding-left: 	20px;
			text-align: 	left;
		}
		
		/*	*	*	*	FILE CHOOSER	*	*	*	*/
		#fileinput {
			margin-left:	5px;
		}
	</style>
	
	<script type="text/javascript">	
	const THE_IMAGE_ID = "image";
	const THE_IMAGECAPTION_ID = "imagecaption";
	const WELCOME_ID = "welcome";
	const USER_CLICKABLE_NUMBER_ID = "usersecondsbox";
	const MENTIONS_OF_SECONDS_CLASS = "numsec";
	const TIMELEFT_ID = "timeleft";
	const TGH_ID = "tgh";
	const PLAYPAUSE_ID = "playpause";
	const LEFTARROW_ID = "leftarrow";
	const RIGHTARROW_ID = "rightarrow";
	const IMAGEHOLDER_ID = "imageholder";
	const TIMER_UPDATE_INTERVAL_SECONDS = 0.25;

	const LEFTARROW_UNICODE = "&lsaquo;";
	const RIGHTARROW_UNICODE = "&rsaquo;";
	const PLAYBUTTON_UNICODE = "&#9654;";
	const PAUSEBUTTON_UNICODE = "&#9208;";

	var MENTIONS_OF_SECONDS_SELECTOR = "." + MENTIONS_OF_SECONDS_CLASS;

	const DEFAULT_SECONDS = 30;
	const KEY_ENTER = 13;
	const KEY_LEFT = 37;
	const KEY_RIGHT = 39;
	const KEY_PLAYPAUSE = 32;

	var REST_OF_TITLE = "-Second Viewer";
	var theFileArray = 0;
	var viewHelp = false;
	

	var VIEWER_FILENAME = function() {
		var url = document.location.href;
		url = url.substring(0, (url.indexOf("#") == -1) ? url.length : url.indexOf("#"));
		url = url.substring(0, (url.indexOf("?") == -1) ? url.length : url.indexOf("?"));
		url = url.substring(url.lastIndexOf("/") + 1, url.length);
		return url;
	}();

	document.addEventListener('DOMContentLoaded', function() {
		if (window.File && window.FileReader && window.FileList && window.Blob) {	//check for file-reader compatibility
			viewerInterface.initialize();
		} else {
			alert('The File APIs are not fully supported by your browser.');
		}
	});

	// *		*		*		*		*		 VIEWER INTERFACE OBJECT		*		*		*		*		* 
	var viewerInterface = {
		getCustomNumberElement: function() { return document.getElementById(USER_CLICKABLE_NUMBER_ID); },
		getUserSecondsFieldValue: function() { return this.getCustomNumberElement().value; },
		getValidUserSeconds: function() { return parseInt(this.getUserSecondsFieldValue(), 10) },
		getCurrentImage: function() { return listData.fileNameArray[circulator.getCurrentImageIndex()]; },

		initialize: function() {
			this.localizeText();
			this.initializeButtons();
		},

		initializeButtons: function() {
			// Bind circulator update to interface update
			circulator.onUpdate = () => { viewerInterface.updateTimeIndicator() };
			circulator.onImageChanged = () => { imageHolder.setImage(viewerInterface.getCurrentImage()); };

			// Bind click events
			// These need to be anonymous functions so they don't break the subsequent invisible -this- parameter during function dereferencing
			document.getElementById(RIGHTARROW_ID).addEventListener('click', () => { circulator.forceNext(); } );
			document.getElementById(LEFTARROW_ID).addEventListener('click', () => { circulator.forcePrevious(); } );
			document.getElementById(IMAGEHOLDER_ID).addEventListener('click', () => { imageHolder.toggleImageZoom(); } );
			
			// Bind event for when user changes files
			var fileInputElement = document.getElementById("fileinput");
			fileInputElement.setAttribute("accept", "image/*");
			fileInputElement.addEventListener("change", () => {
				listData.newFileArray();
				viewerInterface.initializeImage();
				viewerInterface.refreshSubHeader();
			});			
			
			var numberElement = this.getCustomNumberElement();

			// Bind custom-time textbox events
			numberElement.addEventListener("click", () => {
				numberElement.focus();
				numberElement.select();
			});

			numberElement.addEventListener("keydown", function(event) {
				var valToCheck = parseInt(numberElement.value, 10);
				
				//TODO set new time only if textbox is a valid number
				//TODO do active checking while textbox is being edited (add change listener)
				//TODO apply changes and reset timer when user presses enter in textbox

				var interfaceCustomNumberElement = viewerInterface.getCustomNumberElement();

				// when you press enter
				if (event.keyCode === KEY_ENTER) {	
					event.preventDefault();
					interfaceCustomNumberElement.blur();		// lose focus on textbox
					
					// TODO: Move this to a separate validate() method.
					if (isNaN(valToCheck)) {
						interfaceCustomNumberElement.value = DEFAULT_SECONDS;	// if it's an invalid value, reset to default (30)
					} else if (valToCheck < circulator.MINIMUM_SECONDS) {
						interfaceCustomNumberElement.value = circulator.MINIMUM_SECONDS;
					}

					// At this point, the number in USER_CLICKABLE_NUMBER should be valid.
					var validnumber = viewerInterface.getUserSecondsFieldValue();			// change text of site to reflect user change:
					viewerInterface.changeAllMentionOfSeconds(validnumber);
					
					if( listData.isPopulated() ) {					// only trigger new duration if the list is populated
						circulator.newDuration();
					}
					
				}
			});
			
			// Bind keyboard input
			document.addEventListener("keydown", (event) => {
				if (event.keyCode === KEY_LEFT)			{ circulator.forcePrevious();	}
				if (event.keyCode === KEY_RIGHT)		{ circulator.forceNext(); 		}
				if (event.keyCode === KEY_PLAYPAUSE)	{ circulator.togglePlayPause();	}
			});

		},

		localizeText: function() {
			if (Math.floor((Math.random() * 50)) == 20) REST_OF_TITLE = "-Second Hamburger";	//proc hamburger

			var secondsSetting = this.getCustomNumberElement().value;

			this.changeAllMentionOfSeconds(secondsSetting);
			document.getElementById(LEFTARROW_ID).innerHTML = LEFTARROW_UNICODE;
			document.getElementById(RIGHTARROW_ID).innerHTML = RIGHTARROW_UNICODE;
			//document.getElementById(PLAYPAUSE_ID).innerHTML = PLAYBUTTON_UNICODE;

			document.querySelectorAll("header > h1").forEach((el) => { el.innerHTML = REST_OF_TITLE; });
			document.querySelectorAll(".viewerfilename").forEach((el) => { el.innerHTML = VIEWER_FILENAME; });

			var WARNING_TITLES = ["ACHTUNG!", "CAUTION!", "ATTENTION!", "WARNING!", "DESU DESU!!", "ADVERTENCIA!"];
			var titlerand = Math.floor((Math.random() * WARNING_TITLES.length))
			document.getElementById("warningtitle").innerHTML = WARNING_TITLES[titlerand];

			var welcomeClassList = document.getElementById(WELCOME_ID).classList;
			welcomeClassList.add("helpon");
			welcomeClassList.remove("helpoff");
		},

		initializeImage: function() {
			imageHolder.toggleImageZoom();
			imageHolder.setImage(viewerInterface.getCurrentImage());
		},

		refreshSubHeader: function() {
			document.getElementById(TGH_ID).innerHTML = "[ " + listData.toString() + " : <span class='" + MENTIONS_OF_SECONDS_CLASS  + "'>" +  circulator.lastsecondsBetween + "</span> seconds each ]";
			var welcomeClassList = document.getElementById(WELCOME_ID).classList;
			welcomeClassList.remove("helpon");
			welcomeClassList.add("helpoff");
		},

		changeAllMentionOfSeconds: function(numofseconds) {
			this.getCustomNumberElement().value = numofseconds;
			document.querySelector("title").innerHTML = numofseconds + REST_OF_TITLE;		
			document.querySelectorAll(MENTIONS_OF_SECONDS_SELECTOR).forEach((el) => { el.innerHTML = numofseconds; });
		},

		showListData: function() {
			document.getElementById(TGH_ID).innerHTML = listData.toString();
		},

		updateTimeIndicator: function() {
			document.getElementById(TIMELEFT_ID).innerHTML = this.toDotRepresentation(circulator.secondsLeft, circulator.lastsecondsBetween);
		},

		toDotRepresentation: (timeinSeconds, maxtime) => {
			var dotstring = "";
			var numofdots = timeinSeconds/maxtime * 90;
			for(var rrr = 0; rrr < numofdots; rrr++) {
				dotstring = dotstring + ".";
				if( (rrr + 1) % 30 == 0 && rrr != 0) dotstring += "<br />";
			}
			return dotstring;
		}

	};
		

	// *		*		*		*		*		 CIRCULATOR OBJECT 			*		*		*		*		* 
	var circulator = {
		isActive: true,
		currentNumber: 0,
		secondsLeft: 30,
		lastsecondsBetween: 30,
		secondsBetween: 30,
		MINIMUM_SECONDS: 5,
		counter: 0,
		onUpdate: null,
		onImageChanged: null,
		
		togglePlayPause: function() {
			this.isActive = !(this.isActive);
			// TODO: Make time left indicator clickable
			// TODO: Make dots turn red when paused
			// TODO: Make play pause symbol visible when you hover over the dots (or the arrows?)
			// TODO: make play symbol always visible when paused.
		},
		
		updateTime: function() {
			if (this.isActive) {
				this.secondsLeft -= TIMER_UPDATE_INTERVAL_SECONDS;
				if (this.secondsLeft < 0) {
					this.restartTimer();
					this.next();
				}
				if (this.onUpdate != null) this.onUpdate();
			}
		},

		initTimer: function() {
			this.restartTimer();
			
			clearInterval(this.counter);				//stop the previous counter (if it exists?)
			this.counter = setInterval(	() => {	circulator.updateTime(); },
										TIMER_UPDATE_INTERVAL_SECONDS * 1000
										);
		},
		restartTimer: function() {
			this.readTextBoxTime();
			this.lastsecondsBetween = this.secondsBetween;
			this.secondsLeft = this.secondsBetween;
		},
		readTextBoxTime: function() {
			this.secondsBetween	= viewerInterface.getValidUserSeconds();
		},
		
		newDuration: function() {
			this.restartTimer();
			if (this.onUpdate != null) this.onUpdate();
		},
		forceNext: function() {
			if (listData.isPopulated()) {
				this.next();
				this.newDuration();
			}
		},
		forcePrevious: function() {
			if (listData.isPopulated()) {
				this.prev();
				this.newDuration();
			}
		},
		next: function() {
			if (this.currentNumber < listData.fileNameArray.length - 1) this.currentNumber++;
			else this.currentNumber = 0;
			
			if (this.onImageChanged != null) this.onImageChanged();			
		},
		prev: function() {
			if (this.currentNumber > 0) this.currentNumber--;
			else this.currentNumber = listData.fileNameArray.length - 1;
			if (this.onImageChanged != null) this.onImageChanged();
		},

		// SHUFFLE	(uses an array of ints from 0 to the last index of the data array)
		// Instead of shuffling the filename array, or just randomly picking from it.
		// An persistent array of shuffled indexes is kept so the user can freely go back to a previous image.
		imageOrder: [],
		getCurrentImageIndex: () => { return circulator.imageOrder[circulator.currentNumber]; },
		newOrder: function() {
			this.resetImageOrder();
			this.shuffleImageOrder();
			if (this.onImageChanged != null) this.onImageChanged();
		},
		resetImageOrder: function() {
			this.imageOrder = new Array(listData.fileNameArray.length);
			for(var qq = 0; qq < this.imageOrder.length; qq++) {
				this.imageOrder[qq] = qq;
			}
		},
		shuffleImageOrder: function() {
			var iterations = Math.floor(this.imageOrder.length * 2 / 3);
			for (var xx = 0; xx < iterations; xx++) {
				var swapBuffer = this.imageOrder[xx];
				var swapPartner = Math.floor((Math.random() * this.imageOrder.length)); 
				this.imageOrder[xx] = this.imageOrder[swapPartner];
				this.imageOrder[swapPartner] = swapBuffer;
			}
		},
	};
	
	// *		*		*		*		*		 IMAGE HOLDER OBJECT 		*		*		*		*		*
	var imageHolder = {
		isImageZoomed: true,
		setImage: function(filename) {
			var imageElement = document.getElementById(THE_IMAGE_ID);
			imageElement.setAttribute("src", "" + filename);
			var imagecaption = imageElement.getAttribute("src");
			document.getElementById(THE_IMAGECAPTION_ID).innerHTML = imagecaption;
		},
		toggleImageZoom: function() {
			this.isImageZoomed = !this.isImageZoomed;
			var imageElement = document.getElementById(THE_IMAGE_ID);

			if (this.isImageZoomed) {
				imageElement.style.maxHeight = "none";
			}
			else if (!this.isImageZoomed) {
				var targetHeight = window.innerHeight - 100;
				imageElement.style.maxHeight = targetHeight + "px";
			}
		}
	};

	// *		*		*		*		*		 LIST DATA OBJECT 			*		*		*		*		*
	var listData = {
		theListFile: "",
		fileNameArray: [],
		newFileArray: function() {
			theFileArray = document.getElementById("fileinput").files;		// take the files array from the <input> tag

			// Copy the filenames from the file array
			this.fileNameArray = new Array(theFileArray.length);
			for (var i = 0; i < theFileArray.length; i++) {
				this.fileNameArray[i] = theFileArray[i].name;
			}

			circulator.newOrder();
			circulator.initTimer();
		},
		isPopulated: function() {
			return (listData.fileNameArray.length > 1);
		},
		toString: function() {
			return this.fileNameArray.length + " images"; 
		}
	};	
	</script>
</head>
	<body>
		<div id="overallholder">					
			<div id="imageholder"><div id="imagecaption"> </div><img src="" id="image" /></div>
		</div>
		<header>
			<input type="text" size="1" value="30" id="usersecondsbox" /><h1> </h1>
			<div id="welcome" class="helpoff">
				<p>This is Pharan's <span class="numsec">30</span>-Second Viewer, a <a href="http://en.wikipedia.org/wiki/Gesture_drawing">gesture drawing</a> training tool
					for helping artists practice their perceptual skills: identifying 
					overall shapes and quickly seeing and capturing the components of shapes and poses 
					that contribute the most to the feeling, movement, action or realism of a subject.<br/>
					You can load image files and it will pick out and display a random image from the set every <span class="numsec">30</span> seconds.</p>
				<p><strong id="warningtitle">WARNING!</strong><br />
					For security reasons, modern browsers don't allow access to just any folder on your computer. So this tool can only work with images in the folder where it's saved.</p>
				<p>In this context, this is how to open a set of images:</p>
				<ol>
					<li>Copy this file (<span class="viewerfilename"></span>) into the folder where you have your image files.</li>
					<li>Open this file (<span class="viewerfilename"></span>), or double-click on it in Finder/File Explorer to open it in your default browser</li>
					<li>Click on the "Browse..." button below this text to choose files.</li>
					<li>Browse to the <strong>folder where you saved "<span class="viewerfilename"></span>".</strong></li>
					<li>Select all the images you want in that folder and click "Open".</li>
				</ol>
			</div>
			<p id="tgh"> </p>
			<input type="file" id="fileinput" multiple />	
		</header>
		<nav id="arrowholder">
			<div id="leftarrow"> </div>
			<div id="timeleft"> </div>
			<div id="rightarrow"> </div>
		</nav>
	</body>
</html>
